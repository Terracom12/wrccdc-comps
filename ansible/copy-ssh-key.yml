---
- name: Deploy SSH Public Key to all Linux Hosts
  hosts: linux
  # We do NOT need 'become: true' because we are connecting
  # as the 'admin' user and modifying that user's own home directory.
  become: false
  gather_facts: false

  vars:
    # --- IMPORTANT ---
    # This is the path to the public key on YOUR (control) machine.
    # Change this if your key is in a different location.
    # local_ssh_pubkey_file: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa.pub"
    local_ssh_pubkey_file: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519.pub"

  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0700'

    - name: Deploy authorized key
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ lookup('file', local_ssh_pubkey_file) }}"
        state: present
      register: key_deploy_status

    - name: Report on key deployment
      ansible.builtin.debug:
        msg: "SSH key was successfully added to {{ inventory_hostname }}."
      when: key_deploy_status.changed
